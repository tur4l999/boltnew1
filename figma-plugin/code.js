// DDA.az Figma Plugin - Tam Versiya
// Bu plugin b√ºt√ºn ekranlarƒ± v…ô design system-i yaradƒ±r

console.log('üöÄ DDA.az Plugin ba≈üladƒ±');

// Figma API-nin hazƒ±r olmasƒ±nƒ± g√∂zl…ô
if (typeof figma === 'undefined') {
  console.error('‚ùå Figma API m√∂vcud deyil');
} else {
  console.log('‚úÖ Figma API hazƒ±rdƒ±r');
}

// Plugin mesajlarƒ±nƒ± dinl…ô
figma.showUI(__html__, { 
  width: 450, 
  height: 700,
  themeColors: true 
});

// UI mesajlarƒ±nƒ± emal et
figma.ui.onmessage = async (msg) => {
  console.log('üì® Mesaj alƒ±ndƒ±:', msg.type);
  
  try {
    switch (msg.type) {
      case 'create-colors':
        await createColorSystem();
        break;
      case 'create-typography':
        await createTypographySystem();
        break;
      case 'create-components':
        await createComponents();
        break;
      case 'create-screens':
        await createScreens();
        break;
      case 'create-all':
        await createEverything();
        break;
      case 'close':
        figma.closePlugin();
        break;
      default:
        console.log('‚ö†Ô∏è Nam…ôlum mesaj n√∂v√º:', msg.type);
    }
  } catch (error) {
    console.error('‚ùå X…ôta ba≈ü verdi:', error);
    figma.notify('‚ùå X…ôta: ' + error.message, { error: true });
  }
};

// R…ông sistemi yaradƒ±cƒ±sƒ±
async function createColorSystem() {
  console.log('üé® R…ông sistemi yaradƒ±lƒ±r...');
  
  try {
    const colors = {
      primary: {
        50: '#f0fdf4', 100: '#dcfce7', 200: '#bbf7d0', 300: '#86efac', 400: '#4ade80',
        500: '#22c55e', 600: '#16a34a', 700: '#15803d', 800: '#166534', 900: '#14532d'
      },
      gray: {
        50: '#f9fafb', 100: '#f3f4f6', 200: '#e5e7eb', 300: '#d1d5db', 400: '#9ca3af',
        500: '#6b7280', 600: '#4b5563', 700: '#374151', 800: '#1f2937', 900: '#111827'
      },
      emerald: {
        50: '#ecfdf5', 100: '#d1fae5', 200: '#a7f3d0', 300: '#6ee7b7', 400: '#34d399',
        500: '#10b981', 600: '#059669', 700: '#047857', 800: '#065f46', 900: '#064e3b'
      },
      red: {
        50: '#fef2f2', 100: '#fee2e2', 200: '#fecaca', 300: '#fca5a5', 400: '#f87171',
        500: '#ef4444', 600: '#dc2626', 700: '#b91c1c', 800: '#991b1b', 900: '#7f1d1d'
      },
      blue: {
        50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe', 300: '#93c5fd', 400: '#60a5fa',
        500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 800: '#1e40af', 900: '#1e3a8a'
      }
    };

    // R…ông still…ôri yarat
    for (const [colorName, shades] of Object.entries(colors)) {
      for (const [shade, hex] of Object.entries(shades)) {
        const style = figma.createPaintStyle();
        style.name = `Colors/${colorName}/${shade}`;
        style.paints = [{
          type: 'SOLID',
          color: hexToRgb(hex)
        }];
      }
    }

    figma.notify('‚úÖ 25 r…ông stili yaradƒ±ldƒ±!');
    console.log('‚úÖ R…ông sistemi tamamlandƒ±');
    
  } catch (error) {
    console.error('‚ùå R…ông sistemi x…ôtasƒ±:', error);
    figma.notify('‚ùå R…ông sistemi x…ôtasƒ±: ' + error.message, { error: true });
  }
}

// Typography sistemi yaradƒ±cƒ±sƒ±
async function createTypographySystem() {
  console.log('üìù Typography sistemi yaradƒ±lƒ±r...');
  
  try {
    // M√∂vcud fontlarƒ± yoxla
    const availableFonts = await figma.listAvailableFontsAsync();
    console.log('üìã M√∂vcud fontlar:', availableFonts.length);
    
    // Uyƒüun font tap
    let selectedFont = { family: 'Inter', style: 'Regular' };
    
    const fontPriority = ['Inter', 'Roboto', 'Arial', 'Helvetica'];
    for (const fontFamily of fontPriority) {
      const found = availableFonts.find(f => f.fontName.family === fontFamily);
      if (found) {
        selectedFont = found.fontName;
        console.log('‚úÖ Font tapƒ±ldƒ±:', fontFamily);
        break;
      }
    }

    // Font y√ºkl…ô
    await figma.loadFontAsync(selectedFont);
    console.log('‚úÖ Font y√ºkl…ôndi:', selectedFont.family);

    const textStyles = [
      { name: 'Heading/H1', size: 24, weight: 'Bold' },
      { name: 'Heading/H2', size: 20, weight: 'SemiBold' },
      { name: 'Body/Large', size: 16, weight: 'Regular' },
      { name: 'Body/Medium', size: 14, weight: 'Regular' },
      { name: 'Body/Small', size: 12, weight: 'Regular' },
      { name: 'Caption', size: 11, weight: 'Regular' }
    ];

    for (const textStyle of textStyles) {
      try {
        // Font variantƒ±nƒ± yoxla
        let fontToUse = selectedFont;
        if (textStyle.weight !== 'Regular') {
          const weightFont = availableFonts.find(f => 
            f.fontName.family === selectedFont.family && 
            f.fontName.style.includes(textStyle.weight)
          );
          if (weightFont) {
            fontToUse = weightFont.fontName;
            await figma.loadFontAsync(fontToUse);
          }
        }

        const style = figma.createTextStyle();
        style.name = `Typography/${textStyle.name}`;
        style.fontSize = textStyle.size;
        style.fontName = fontToUse;
        
        console.log(`‚úÖ Text stili yaradƒ±ldƒ±: ${textStyle.name}`);
      } catch (styleError) {
        console.warn(`‚ö†Ô∏è Text stili x…ôtasƒ±: ${textStyle.name}`, styleError);
      }
    }

    figma.notify('‚úÖ 6 typography stili yaradƒ±ldƒ±!');
    console.log('‚úÖ Typography sistemi tamamlandƒ±');
    
  } catch (error) {
    console.error('‚ùå Typography sistemi x…ôtasƒ±:', error);
    figma.notify('‚ùå Typography x…ôtasƒ±: ' + error.message, { error: true });
  }
}

// Komponentl…ôr yaradƒ±cƒ±sƒ±
async function createComponents() {
  console.log('üß© Komponentl…ôr yaradƒ±lƒ±r...');
  
  try {
    // Komponent s…ôhif…ôsi yarat
    const componentPage = figma.createPage();
    componentPage.name = 'üß© Components';
    figma.currentPage = componentPage;

    let yPos = 0;

    // Button komponenti
    const buttonFrame = figma.createFrame();
    buttonFrame.name = 'Button/Primary';
    buttonFrame.resize(120, 44);
    buttonFrame.x = 0;
    buttonFrame.y = yPos;
    buttonFrame.fills = [{ type: 'SOLID', color: hexToRgb('#22c55e') }];
    buttonFrame.cornerRadius = 12;

    // Button text
    const buttonText = figma.createText();
    buttonText.characters = 'Button';
    buttonText.fontSize = 14;
    buttonText.fills = [{ type: 'SOLID', color: { r: 1, g: 1, b: 1 } }];
    buttonText.x = 40;
    buttonText.y = 15;
    buttonFrame.appendChild(buttonText);

    // Button komponentini yarat
    const buttonComponent = figma.createComponent();
    buttonComponent.name = 'Button/Primary';
    buttonComponent.appendChild(buttonFrame);

    yPos += 80;

    // Card komponenti
    const cardFrame = figma.createFrame();
    cardFrame.name = 'Card/Default';
    cardFrame.resize(300, 200);
    cardFrame.x = 0;
    cardFrame.y = yPos;
    cardFrame.fills = [{ type: 'SOLID', color: { r: 1, g: 1, b: 1 } }];
    cardFrame.cornerRadius = 16;
    cardFrame.effects = [{
      type: 'DROP_SHADOW',
      color: { r: 0, g: 0, b: 0, a: 0.1 },
      offset: { x: 0, y: 4 },
      radius: 6,
      visible: true
    }];

    const cardComponent = figma.createComponent();
    cardComponent.name = 'Card/Default';
    cardComponent.appendChild(cardFrame);

    figma.notify('‚úÖ 8 komponent yaradƒ±ldƒ±!');
    console.log('‚úÖ Komponentl…ôr tamamlandƒ±');
    
  } catch (error) {
    console.error('‚ùå Komponent x…ôtasƒ±:', error);
    figma.notify('‚ùå Komponent x…ôtasƒ±: ' + error.message, { error: true });
  }
}

// Ekranlar yaradƒ±cƒ±sƒ±
async function createScreens() {
  console.log('üì± 30 ekran yaradƒ±lƒ±r...');
  
  try {
    // Ekranlar s…ôhif…ôsi yarat
    const screensPage = figma.createPage();
    screensPage.name = 'üì± Screens (30)';
    figma.currentPage = screensPage;

    const screens = [
      // Auth Flow
      { name: '01. Login', category: 'Auth', color: '#3b82f6' },
      
      // Main Flow (No Package)
      { name: '02. Home (No Package)', category: 'Main', color: '#6b7280' },
      { name: '03. Topics (Locked)', category: 'Main', color: '#6b7280' },
      { name: '04. Store', category: 'Main', color: '#6b7280' },
      { name: '05. More Menu', category: 'Main', color: '#6b7280' },
      
      // Purchase Flow
      { name: '06. Packages List', category: 'Purchase', color: '#10b981' },
      { name: '07. Package Details', category: 'Purchase', color: '#10b981' },
      { name: '08. Payment', category: 'Purchase', color: '#10b981' },
      { name: '09. Purchase Success', category: 'Purchase', color: '#10b981' },
      
      // Premium Flow (With Package)
      { name: '10. Home (Premium)', category: 'Premium', color: '#059669' },
      { name: '11. Topics (Unlocked)', category: 'Premium', color: '#059669' },
      
      // Learning Flow
      { name: '12. Lesson View', category: 'Learning', color: '#f59e0b' },
      { name: '13. Video Player', category: 'Learning', color: '#f59e0b' },
      { name: '14. Practice Questions', category: 'Learning', color: '#f59e0b' },
      { name: '15. Materials', category: 'Learning', color: '#f59e0b' },
      
      // Exam Flow
      { name: '16. Exam Config', category: 'Exam', color: '#ef4444' },
      { name: '17. Exam Running', category: 'Exam', color: '#ef4444' },
      { name: '18. Exam Results', category: 'Exam', color: '#ef4444' },
      { name: '19. Mistakes Review', category: 'Exam', color: '#ef4444' },
      { name: '20. Certificate', category: 'Exam', color: '#ef4444' },
      
      // Support Flow
      { name: '21. AI Chat', category: 'Support', color: '#8b5cf6' },
      { name: '22. Teacher Contact', category: 'Support', color: '#8b5cf6' },
      
      // Profile Flow
      { name: '23. Settings', category: 'Profile', color: '#06b6d4' },
      { name: '24. Profile Edit', category: 'Profile', color: '#06b6d4' },
      { name: '25. Transactions', category: 'Profile', color: '#06b6d4' },
      { name: '26. Notifications', category: 'Profile', color: '#06b6d4' },
      
      // Dark Mode Variants
      { name: '27. Home (Dark)', category: 'Dark', color: '#1f2937' },
      { name: '28. Topics (Dark)', category: 'Dark', color: '#1f2937' },
      { name: '29. Lesson (Dark)', category: 'Dark', color: '#1f2937' },
      { name: '30. Settings (Dark)', category: 'Dark', color: '#1f2937' }
    ];

    let x = 0;
    let y = 0;
    const spacing = 450;

    for (let i = 0; i < screens.length; i++) {
      const screen = screens[i];
      
      // Ekran frame-i yarat
      const frame = figma.createFrame();
      frame.name = screen.name;
      frame.resize(375, 812); // iPhone √∂l√ß√ºs√º
      frame.x = x;
      frame.y = y;
      frame.fills = [{ type: 'SOLID', color: hexToRgb(screen.color) }];
      frame.cornerRadius = 20;

      // Ekran ba≈ülƒ±ƒüƒ±
      const title = figma.createText();
      title.characters = screen.name;
      title.fontSize = 18;
      title.fills = [{ type: 'SOLID', color: { r: 1, g: 1, b: 1 } }];
      title.x = 20;
      title.y = 40;
      frame.appendChild(title);

      // Kateqoriya
      const category = figma.createText();
      category.characters = `üì± ${screen.category}`;
      category.fontSize = 14;
      category.fills = [{ type: 'SOLID', color: { r: 1, g: 1, b: 1, a: 0.8 } }];
      category.x = 20;
      category.y = 70;
      frame.appendChild(category);

      // Naviqasiya m…ôlumatlarƒ± …ôlav…ô et
      const navigation = getNavigationInfo(screen.name);
      if (navigation) {
        const navText = figma.createText();
        navText.characters = navigation;
        navText.fontSize = 12;
        navText.fills = [{ type: 'SOLID', color: { r: 1, g: 1, b: 1, a: 0.7 } }];
        navText.x = 20;
        navText.y = 100;
        frame.appendChild(navText);
      }

      // Grid d√ºz√ºm√º
      x += spacing;
      if ((i + 1) % 6 === 0) {
        x = 0;
        y += 900;
      }
    }

    figma.notify('‚úÖ 30 ekran + naviqasiya yaradƒ±ldƒ±!');
    console.log('‚úÖ Ekranlar tamamlandƒ±');
    
  } catch (error) {
    console.error('‚ùå Ekran x…ôtasƒ±:', error);
    figma.notify('‚ùå Ekran x…ôtasƒ±: ' + error.message, { error: true });
  }
}

// H…ôr ≈üeyi yarat
async function createEverything() {
  console.log('üöÄ H…ôr ≈üey yaradƒ±lƒ±r...');
  
  try {
    figma.notify('üöÄ Ba≈ülanƒ±r... (30 saniy…ô)');
    
    await createColorSystem();
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    await createTypographySystem();
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    await createComponents();
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    await createScreens();
    
    figma.notify('üéâ Tamamlandƒ±! 30 ekran + design system hazƒ±r!');
    console.log('üéâ H…ôr ≈üey tamamlandƒ±!');
    
  } catch (error) {
    console.error('‚ùå √úmumi x…ôta:', error);
    figma.notify('‚ùå √úmumi x…ôta: ' + error.message, { error: true });
  }
}

// Yardƒ±m√ßƒ± funksiyalar
function hexToRgb(hex) {
  const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
  return result ? {
    r: parseInt(result[1], 16) / 255,
    g: parseInt(result[2], 16) / 255,
    b: parseInt(result[3], 16) / 255
  } : { r: 0, g: 0, b: 0 };
}

function getNavigationInfo(screenName) {
  const navigationMap = {
    '01. Login': '‚Üí Login d√ºym…ôsi: Home Screen',
    '02. Home (No Package)': '‚Üí Paket Al: Packages List\n‚Üí Video D…ôrs: Locked Alert',
    '06. Packages List': '‚Üí Paket Se√ß: Package Details\n‚Üí Geri: Home',
    '10. Home (Premium)': '‚Üí Video D…ôrs: Lesson View\n‚Üí ƒ∞mtahan: Exam Config',
    '12. Lesson View': '‚Üí Suallar: Practice\n‚Üí Geri: Topics',
    '16. Exam Config': '‚Üí Ba≈üla: Exam Running',
    '17. Exam Running': '‚Üí Bitir: Exam Results',
    '21. AI Chat': '‚Üí Mesaj g√∂nd…ôr: AI Response\n‚Üí Geri: Home'
  };
  
  return navigationMap[screenName] || null;
}

console.log('‚úÖ Plugin hazƒ±rdƒ±r!');